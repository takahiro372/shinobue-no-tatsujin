import{r as f,c as z,u as D,a as O,b as V,d as X,e as Z,f as Q,j as l,g as ee,h as te,i as re,k as oe}from"./index-NfBeE4Ix.js";function ne(e){const[r,o]=f.useState(e??z()),[t,a]=f.useState(null),[i,d]=f.useState(1),[s,n]=f.useState("quarter"),u=f.useRef([]),h=f.useRef([]),c=f.useCallback(g=>{u.current=[...u.current.slice(-49),g],h.current=[]},[]),m=f.useCallback(()=>{const g=u.current.pop();g&&(h.current.push(r),o(g),a(null))},[r]),b=f.useCallback(()=>{const g=h.current.pop();g&&(u.current.push(r),o(g),a(null))},[r]),p=f.useCallback((g,C,M,P="note")=>{c(r);const S=Z({type:P,pitch:C,durationType:s,startBeat:M}),j=D(r,g,J=>X(J,S));return o(j),a(S.id),S.id},[r,s,c]),v=f.useCallback((g,C)=>{c(r);const M=D(r,g,P=>Q(P,C));o(M),t===C&&a(null)},[r,t,c]),w=f.useCallback((g,C,M)=>{c(r);const P=D(r,C,S=>({...S,notes:S.notes.map(j=>j.id===g?{...j,duration:{...j.duration,type:M}}:j)}));o(P)},[r,c]),k=f.useCallback(()=>{c(r),o(O(r))},[r,c]),T=f.useCallback(g=>{r.measures.length<=1||(c(r),o(V(r,g)),i===g&&d(Math.max(1,g-1)))},[r,i,c]),I=f.useCallback(g=>{c(r),o({...r,metadata:{...r.metadata,...g}})},[r,c]),q=f.useCallback(g=>{c(r),o(g),a(null),d(1)},[r,c]);return{score:r,selectedNoteId:t,selectedMeasure:i,currentDuration:s,canUndo:u.current.length>0,canRedo:h.current.length>0,setSelectedNoteId:a,setSelectedMeasure:d,setCurrentDuration:n,addNote:p,deleteNote:v,changeDuration:w,addMeasure:k,deleteMeasure:T,updateMetadata:I,loadScore:q,undo:m,redo:b}}const se=[{type:"whole",label:"å…¨",shortcut:"1"},{type:"half",label:"äºŒåˆ†",shortcut:"2"},{type:"quarter",label:"å››åˆ†",shortcut:"4"},{type:"eighth",label:"å…«åˆ†",shortcut:"8"},{type:"sixteenth",label:"åå…­",shortcut:"6"}];function ie({currentDuration:e,onDurationChange:r,onAddMeasure:o,canUndo:t,canRedo:a,onUndo:i,onRedo:d,tempo:s,onTempoChange:n,title:u,onTitleChange:h}){return l.jsxs("div",{className:"bg-white rounded-lg shadow p-3 flex flex-wrap items-center gap-3",children:[l.jsx("input",{type:"text",value:u,onChange:c=>h(c.target.value),className:"border rounded px-2 py-1 text-sm w-40",placeholder:"æ›²å"}),l.jsx("div",{className:"flex gap-1 border-l pl-3",children:se.map(c=>l.jsx("button",{onClick:()=>r(c.type),className:`px-2 py-1 text-xs rounded font-medium transition-colors ${e===c.type?"bg-[#C41E3A] text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,title:`${c.label}éŸ³ç¬¦ (${c.shortcut})`,children:c.label},c.type))}),l.jsxs("div",{className:"flex items-center gap-1 border-l pl-3",children:[l.jsx("span",{className:"text-xs text-gray-500",children:"BPM"}),l.jsx("input",{type:"number",value:s,onChange:c=>n(Number(c.target.value)),className:"w-14 border rounded px-1 py-1 text-xs text-center",min:30,max:300})]}),l.jsxs("div",{className:"flex gap-1 border-l pl-3",children:[l.jsx("button",{onClick:i,disabled:!t,className:"px-2 py-1 text-xs rounded bg-gray-100 hover:bg-gray-200 disabled:opacity-30 disabled:cursor-not-allowed",title:"å…ƒã«æˆ»ã™ (Ctrl+Z)",children:"â†© æˆ»ã™"}),l.jsx("button",{onClick:d,disabled:!a,className:"px-2 py-1 text-xs rounded bg-gray-100 hover:bg-gray-200 disabled:opacity-30 disabled:cursor-not-allowed",title:"ã‚„ã‚Šç›´ã— (Ctrl+Y)",children:"â†ª ã‚„ã‚Šç›´ã—"})]}),l.jsx("button",{onClick:o,className:"px-2 py-1 text-xs rounded bg-[#1B4F72] text-white hover:bg-[#163d5a] border-l ml-auto",children:"+ å°ç¯€è¿½åŠ "})]})}const ae=["ã€‡","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­","ä¸ƒ"];function Y(e){return ae[e]??String(e)}function _(e){switch(e){case"ro":return 0;case"kan":return 1;case"daikan":return 2}}function le(e){const r=Y(e.shinobueNumber),o=_(e.register),t="ãƒ»".repeat(o);return o>0?`${t}
${r}`:r}function de(e){return e.type==="rest"?"ãƒ¼":e.pitch?le(e.pitch):"ï¼Ÿ"}function x(e){switch(e){case"eighth":return 1;case"sixteenth":return 2;case"thirty-second":return 3;default:return 0}}function ce(e,r,o){const{x:t,y:a,cellWidth:i,cellHeight:d,fontSize:s,color:n="#2C2C2C",highlightColor:u="#C41E3A",isHighlighted:h=!1}=o,c=t+i/2,m=a+d/2,b=h?u:n;if(e.save(),e.textAlign="center",e.textBaseline="middle",r.type==="rest"){e.font=`${s}px "Noto Serif JP", serif`,e.fillStyle=b,e.fillText("ãƒ¼",c,m),e.restore();return}if(!r.pitch){e.restore();return}const p=Y(r.pitch.shinobueNumber),v=_(r.pitch.register);if(v>0){e.font=`${s*.5}px "Noto Serif JP", serif`,e.fillStyle=b;const k="ãƒ»".repeat(v);e.fillText(k,c,m-s*.6)}e.font=`bold ${s}px "Noto Serif JP", serif`,e.fillStyle=b,e.fillText(p,c,m);const w=x(r.duration.type);if(w>0){e.strokeStyle=b,e.lineWidth=1.5;const k=m+s*.5;for(let T=0;T<w;T++){const I=T*4;e.beginPath(),e.moveTo(c-i*.35,k+I),e.lineTo(c+i*.35,k+I),e.stroke()}}r.duration.dots>0&&(e.font=`bold ${s*.6}px serif`,e.fillStyle=b,e.fillText(".",c+i*.3,m+s*.3)),e.restore()}function ue({measure:e,selectedNoteId:r,onNoteClick:o,onEmptyClick:t,onDeleteNote:a}){return l.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-2 min-w-[120px]",children:[l.jsx("div",{className:"text-xs text-gray-400 mb-1",children:e.number}),l.jsx("div",{className:"flex gap-1 items-center min-h-[48px]",children:e.notes.length===0?l.jsx("button",{onClick:()=>t(0),className:"w-full h-12 border-2 border-dashed border-gray-300 rounded text-gray-400 text-xs hover:border-[#C41E3A] hover:text-[#C41E3A] transition-colors",children:"+"}):e.notes.map(i=>l.jsx(he,{note:i,isSelected:i.id===r,onClick:()=>o(i.id),onDelete:()=>a(i.id)},i.id))})]})}function he({note:e,isSelected:r,onClick:o,onDelete:t}){var u;const a=de(e),i=x(e.duration.type),d=ee(e.duration),s=d>=2?"min-w-[48px]":d>=1?"min-w-[36px]":"min-w-[28px]",n=e.pitch?e.pitch.register==="ro"?"text-[#1B4F72]":e.pitch.register==="kan"?"text-[#2D8B4E]":"text-[#C41E3A]":"text-gray-500";return l.jsxs("button",{onClick:o,onDoubleClick:h=>{h.stopPropagation(),t()},className:`${s} h-12 flex flex-col items-center justify-center rounded text-sm font-bold transition-all relative
        ${r?"bg-[#1B4F72]/10 ring-2 ring-[#1B4F72]":"hover:bg-gray-50"}
        ${n}
      `,title:`${((u=e.pitch)==null?void 0:u.western)??"ä¼‘ç¬¦"} (ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§å‰Šé™¤)`,children:[e.pitch&&e.pitch.register!=="ro"&&l.jsx("span",{className:"text-[8px] leading-none",children:"ãƒ»".repeat(e.pitch.register==="kan"?1:2)}),l.jsx("span",{className:"leading-tight",children:a.replace(/[ãƒ»\n]/g,"")}),i>0&&l.jsx("div",{className:"absolute bottom-0.5 left-1/2 -translate-x-1/2 flex flex-col gap-px",children:Array.from({length:i},(h,c)=>l.jsx("div",{className:"w-5 h-px bg-current"},c))}),e.duration.dots>0&&l.jsx("span",{className:"absolute top-1 right-0.5 text-[8px]",children:"."})]})}function fe({shinobueKey:e,onNoteSelect:r,onRestSelect:o}){const t=te(e),a=t.filter(n=>n.register==="ro"),i=t.filter(n=>n.register==="kan"),d=t.filter(n=>n.register==="daikan"),s=n=>{const u={shinobueNumber:n.number,register:n.register,frequency:n.frequency,midiNote:Math.round(re(n.frequency)),western:n.western};r(u)};return l.jsxs("div",{className:"bg-white rounded-lg shadow p-3 space-y-3",children:[l.jsx("h3",{className:"text-sm font-bold text-gray-600",children:"éŸ³ç¬¦å…¥åŠ›"}),l.jsxs("div",{children:[l.jsx("div",{className:"text-xs text-[#1B4F72] font-medium mb-1",children:"å‘‚éŸ³"}),l.jsx("div",{className:"flex gap-1 flex-wrap",children:a.map(n=>l.jsx(F,{note:n,onClick:()=>s(n),color:"bg-[#1B4F72]"},`ro-${n.number}`))})]}),l.jsxs("div",{children:[l.jsx("div",{className:"text-xs text-[#2D8B4E] font-medium mb-1",children:"ç”²éŸ³"}),l.jsx("div",{className:"flex gap-1 flex-wrap",children:i.map(n=>l.jsx(F,{note:n,onClick:()=>s(n),color:"bg-[#2D8B4E]"},`kan-${n.number}`))})]}),l.jsxs("div",{children:[l.jsx("div",{className:"text-xs text-[#C41E3A] font-medium mb-1",children:"å¤§ç”²"}),l.jsx("div",{className:"flex gap-1 flex-wrap",children:d.map(n=>l.jsx(F,{note:n,onClick:()=>s(n),color:"bg-[#C41E3A]"},`daikan-${n.number}`))})]}),l.jsx("button",{onClick:o,className:"w-full py-1.5 text-sm rounded bg-gray-200 text-gray-700 hover:bg-gray-300 transition-colors font-medium",children:"ãƒ¼ (ä¼‘ç¬¦)"})]})}function F({note:e,onClick:r,color:o}){return l.jsx("button",{onClick:r,className:`w-9 h-9 rounded text-white text-sm font-bold ${o} hover:opacity-80 transition-opacity`,title:`${e.name} (${e.western})`,children:e.name.replace(/^(ç”²|å¤§ç”²)/,"")})}const U={mode:"number",width:800,height:600,notesPerRow:16,showMeasureNumbers:!0,staffColor:"#999",noteColor:"#2C2C2C",restColor:"#888",highlightColor:"#C41E3A",selectedColor:"#1B4F72"},E=60,N=10,$=5,W=40,y=20,B=20,R=120,A=80;function ge(e,r,o={}){const t={...U,...o};if(e.clearRect(0,0,t.width,t.height),(t.mode==="western"||t.mode==="both")&&be(e,r,t),t.mode==="number"&&G(e,r,t),t.mode==="both"){const a=K(r,t)*R;e.save(),e.translate(0,a+20),G(e,r,t),e.restore()}}function me(e,r={}){const o={...U,...r},t=K(e,o);return o.mode==="western"?t*R+40:o.mode==="number"?t*A+40:t*R+t*A+60}function K(e,r){const o=e.measures.reduce((t,a)=>t+a.notes.length,0);return Math.max(1,Math.ceil(o/r.notesPerRow))}function be(e,r,o){let t=0,a=0;for(const i of r.measures){for(const d of i.notes){const s=t%o.notesPerRow;s===0&&t>0&&a++;const n=a*R,h=(o.width-y-B-W)/o.notesPerRow,c=y+W+s*h;s===0&&(Ce(e,y,n+E,o.width-B,o.staffColor),Se(e,y+5,n+E,o.staffColor)),s===0&&t>0||d===i.notes[0]&&t>0&&H(e,c-2,n+E,i.barline??"normal",o.staffColor);const m=d.id===o.highlightNoteId,b=d.id===o.selectedNoteId;pe(e,d,{x:c,y:n+E,cellWidth:h,staffLineGap:N,color:b?o.selectedColor??"#1B4F72":o.noteColor,isHighlighted:m,highlightColor:o.highlightColor}),t++}if(i.barline==="final"||i.barline==="double"){const d=(t-1)%o.notesPerRow,s=a*R,u=(o.width-y-B-W)/o.notesPerRow,h=y+W+(d+1)*u;H(e,h,s+E,i.barline,o.staffColor)}}}function pe(e,r,o){const t=o.x+o.cellWidth/2,a=o.isHighlighted?o.highlightColor:o.color;if(r.type==="rest"){e.save(),e.font="16px serif",e.fillStyle=a,e.textAlign="center",e.textBaseline="middle";const s=o.y+o.staffLineGap*2,n=ke(r.duration.type);e.fillText(n,t,s),e.restore();return}if(!r.pitch)return;const i=ye(r.pitch.midiNote,o.y,o.staffLineGap);ve(e,t,i,o.y,o.staffLineGap,o.color),e.save(),e.fillStyle=a,e.strokeStyle=a;const d=r.duration.type!=="whole"&&r.duration.type!=="half";if(Ne(e,t,i,d),r.duration.type!=="whole"){const s=i>o.y+o.staffLineGap*2,n=s?t+5:t-5,u=s?i-o.staffLineGap*3:i+o.staffLineGap*3;e.beginPath(),e.moveTo(n,i),e.lineTo(n,u),e.lineWidth=1.2,e.stroke();const h=we(r.duration.type);if(h>0)for(let c=0;c<h;c++){const m=s?u+c*6:u-c*6;e.beginPath(),e.moveTo(n,m),e.quadraticCurveTo(n+(s?10:-10),m+(s?8:-8),n+(s?2:-2),m+(s?15:-15)),e.lineWidth=1.5,e.stroke()}}if(r.duration.dots>0)for(let s=0;s<r.duration.dots;s++)e.beginPath(),e.arc(t+8+s*5,i-2,2,0,Math.PI*2),e.fill();e.restore()}function ye(e,r,o){const t=L(e),a=L(71);return r+o*2-(t-a)*(o/2)}function L(e){const r=Math.floor(e/12),o=e%12,t=[0,0,1,1,2,3,3,4,4,5,5,6];return r*7+(t[o]??0)}function Ne(e,r,o,t){e.beginPath(),e.ellipse(r,o,5,4,-.3,0,Math.PI*2),t?e.fill():(e.lineWidth=1.5,e.stroke())}function ve(e,r,o,t,a,i){e.save(),e.strokeStyle=i,e.lineWidth=1;const d=t+a*($-1);if(o<t)for(let s=t-a;s>=o-a/2;s-=a)e.beginPath(),e.moveTo(r-8,s),e.lineTo(r+8,s),e.stroke();if(o>d)for(let s=d+a;s<=o+a/2;s+=a)e.beginPath(),e.moveTo(r-8,s),e.lineTo(r+8,s),e.stroke();e.restore()}function we(e){switch(e){case"eighth":return 1;case"sixteenth":return 2;case"thirty-second":return 3;default:return 0}}function ke(e){switch(e){case"whole":return"ð„»";case"half":return"ð„¼";case"quarter":return"ð„¾";case"eighth":return"ð„¿";case"sixteenth":return"ð…€";default:return"ð„¾"}}function Ce(e,r,o,t,a){e.save(),e.strokeStyle=a,e.lineWidth=.8;for(let i=0;i<$;i++){const d=o+i*N;e.beginPath(),e.moveTo(r,d),e.lineTo(t,d),e.stroke()}e.restore()}function Se(e,r,o,t){e.save(),e.font="36px serif",e.fillStyle=t,e.textBaseline="top",e.fillText("ð„ž",r,o-8),e.restore()}function H(e,r,o,t,a){e.save(),e.strokeStyle=a;const i=o,d=o+N*($-1);switch(t){case"double":e.lineWidth=1,e.beginPath(),e.moveTo(r-3,i),e.lineTo(r-3,d),e.stroke(),e.beginPath(),e.moveTo(r,i),e.lineTo(r,d),e.stroke();break;case"final":e.lineWidth=1,e.beginPath(),e.moveTo(r-5,i),e.lineTo(r-5,d),e.stroke(),e.lineWidth=3,e.beginPath(),e.moveTo(r,i),e.lineTo(r,d),e.stroke();break;case"repeat-start":e.lineWidth=3,e.beginPath(),e.moveTo(r,i),e.lineTo(r,d),e.stroke(),e.lineWidth=1,e.beginPath(),e.moveTo(r+4,i),e.lineTo(r+4,d),e.stroke(),e.fillStyle=a;const s=o+N*1.5,n=o+N*2.5;e.beginPath(),e.arc(r+10,s,2,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(r+10,n,2,0,Math.PI*2),e.fill();break;case"repeat-end":e.fillStyle=a;const u=o+N*1.5,h=o+N*2.5;e.beginPath(),e.arc(r-10,u,2,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(r-10,h,2,0,Math.PI*2),e.fill(),e.lineWidth=1,e.beginPath(),e.moveTo(r-4,i),e.lineTo(r-4,d),e.stroke(),e.lineWidth=3,e.beginPath(),e.moveTo(r,i),e.lineTo(r,d),e.stroke();break;default:e.lineWidth=1,e.beginPath(),e.moveTo(r,i),e.lineTo(r,d),e.stroke()}e.restore()}function G(e,r,o){let t=0,a=0;const d=(o.width-y-B)/o.notesPerRow,s=A-10,n=Math.min(24,d*.6);for(const u of r.measures)for(let h=0;h<u.notes.length;h++){const c=u.notes[h],m=t%o.notesPerRow;m===0&&t>0&&a++;const b=y+m*d,p=a*A+10;o.showMeasureNumbers&&h===0&&m===0&&(e.save(),e.font="10px sans-serif",e.fillStyle="#999",e.textAlign="left",e.fillText(`${u.number}`,b,p-2),e.restore()),h===0&&t>0&&(e.save(),e.strokeStyle=o.staffColor,e.lineWidth=1,e.beginPath(),e.moveTo(b-2,p),e.lineTo(b-2,p+s),e.stroke(),e.restore());const v=c.id===o.highlightNoteId,w=c.id===o.selectedNoteId;ce(e,c,{x:b,y:p,cellWidth:d,cellHeight:s,fontSize:n,color:w?o.selectedColor??"#1B4F72":c.type==="rest"?o.restColor:o.noteColor,highlightColor:o.highlightColor,isHighlighted:v}),t++}}function je({score:e,highlightNoteId:r,width:o=760}){const t=f.useRef(null),[a,i]=f.useState("number");return f.useEffect(()=>{const d=t.current;if(!d)return;const s=d.getContext("2d");if(!s)return;const n=me(e,{mode:a,width:o,notesPerRow:16});d.width=o,d.height=n,ge(s,e,{mode:a,width:o,height:n,notesPerRow:16,highlightNoteId:r})},[e,a,o,r]),l.jsxs("div",{className:"bg-white rounded-lg shadow p-4",children:[l.jsxs("div",{className:"flex items-center justify-between mb-3",children:[l.jsx("h3",{className:"text-sm font-bold text-gray-600",children:"ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼"}),l.jsx("div",{className:"flex gap-1",children:["number","western","both"].map(d=>l.jsx("button",{onClick:()=>i(d),className:`px-2 py-1 text-xs rounded transition-colors ${a===d?"bg-[#1B4F72] text-white":"bg-gray-100 text-gray-600 hover:bg-gray-200"}`,children:d==="number"?"æ•°å­—è­œ":d==="western"?"äº”ç·šè­œ":"ä¸¡æ–¹"},d))})]}),l.jsx("div",{className:"overflow-auto border rounded",children:l.jsx("canvas",{ref:t,className:"block"})})]})}function Me({initialScore:e,onScoreChange:r}){const{shinobueKey:o}=oe(),t=ne(e),a=f.useRef(t.score);f.useEffect(()=>{t.score!==a.current&&(a.current=t.score,r==null||r(t.score))},[t.score,r]),f.useEffect(()=>{const s=n=>{n.ctrlKey&&n.key==="z"&&!n.shiftKey&&(n.preventDefault(),t.undo()),(n.ctrlKey&&n.key==="y"||n.ctrlKey&&n.shiftKey&&n.key==="z")&&(n.preventDefault(),t.redo()),(n.key==="Delete"||n.key==="Backspace")&&t.selectedNoteId&&t.deleteNote(t.selectedMeasure,t.selectedNoteId);const u={1:"whole",2:"half",4:"quarter",8:"eighth",6:"sixteenth"};!n.ctrlKey&&!n.altKey&&u[n.key]&&t.setCurrentDuration(u[n.key])};return window.addEventListener("keydown",s),()=>window.removeEventListener("keydown",s)},[t]);const i=f.useCallback(s=>{const n=t.score.measures.find(c=>c.number===t.selectedMeasure);if(!n)return;const u=n.notes[n.notes.length-1],h=u?u.startBeat+1:0;t.addNote(t.selectedMeasure,s,h,"note")},[t]),d=f.useCallback(()=>{const s=t.score.measures.find(h=>h.number===t.selectedMeasure);if(!s)return;const n=s.notes[s.notes.length-1],u=n?n.startBeat+1:0;t.addNote(t.selectedMeasure,void 0,u,"rest")},[t]);return l.jsxs("div",{className:"space-y-4",children:[l.jsx(ie,{currentDuration:t.currentDuration,onDurationChange:t.setCurrentDuration,onAddMeasure:t.addMeasure,canUndo:t.canUndo,canRedo:t.canRedo,onUndo:t.undo,onRedo:t.redo,tempo:t.score.metadata.tempo,onTempoChange:s=>t.updateMetadata({tempo:s}),title:t.score.metadata.title,onTitleChange:s=>t.updateMetadata({title:s})}),l.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-[1fr_200px] gap-4",children:[l.jsxs("div",{className:"space-y-4",children:[l.jsx("div",{className:"overflow-x-auto pb-2",children:l.jsx("div",{className:"flex gap-2 min-w-max",children:t.score.measures.map(s=>l.jsx("div",{onClick:()=>t.setSelectedMeasure(s.number),className:`cursor-pointer transition-all ${t.selectedMeasure===s.number?"ring-2 ring-[#C41E3A] rounded-lg":""}`,children:l.jsx(ue,{measure:s,selectedNoteId:t.selectedNoteId,onNoteClick:n=>{t.setSelectedMeasure(s.number),t.setSelectedNoteId(n)},onEmptyClick:n=>{t.setSelectedMeasure(s.number),t.addNote(s.number,void 0,n,"rest")},onDeleteNote:n=>t.deleteNote(s.number,n)})},s.number))})}),l.jsx(je,{score:t.score,highlightNoteId:t.selectedNoteId})]}),l.jsx(fe,{shinobueKey:o,onNoteSelect:i,onRestSelect:d})]})]})}export{Me as ScoreEditor};
