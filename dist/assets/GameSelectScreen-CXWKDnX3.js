import{l as F,m as L,h as B,k as $,r as v,j as a}from"./index-NfBeE4Ix.js";function P(n,s="nana"){const r=new DOMParser().parseFromString(n,"application/xml"),t=r.querySelector("parsererror");if(t)throw new Error(`MusicXML パースエラー: ${t.textContent}`);if(!r.querySelector("score-partwise"))throw new Error("score-partwise 要素が見つかりません");const f=T(r,"work-title")||T(r,"movement-title")||"無題",p=M(r,"composer")||"",c=M(r,"arranger")||void 0,h=r.querySelectorAll("part");if(h.length===0)throw new Error("part 要素が見つかりません");const l=h[0].querySelectorAll("measure");let e=1,u=[4,4],d=120;const x=[];return l.forEach((w,j)=>{var b,A;const N=w.querySelector("attributes");if(N){const C=N.querySelector("divisions");C!=null&&C.textContent&&(e=parseInt(C.textContent,10));const g=N.querySelector("time");if(g){const I=(b=g.querySelector("beats"))==null?void 0:b.textContent,E=(A=g.querySelector("beat-type"))==null?void 0:A.textContent;I&&E&&(u=[parseInt(I,10),parseInt(E,10)])}}const y=w.querySelectorAll("direction");for(const C of y){const g=C.querySelector("sound");g!=null&&g.getAttribute("tempo")&&(d=parseFloat(g.getAttribute("tempo")))}const k=G(w,e,s),q=w.querySelector("barline");let i="normal";q&&(i=R(q)),j===l.length-1&&i==="normal"&&(i="final"),x.push({number:j+1,notes:k,barline:i})}),{metadata:{title:f,composer:p,arranger:c,shinobueKey:s,tempo:d,timeSignature:u},measures:x}}function G(n,s,o){const r=[];let t=0;const m=B(o),f=n.children;for(let p=0;p<f.length;p++){const c=f[p];if(c.tagName==="forward"){const i=c.querySelector("duration");i!=null&&i.textContent&&(t+=parseInt(i.textContent,10)/s);continue}if(c.tagName==="backup"){const i=c.querySelector("duration");i!=null&&i.textContent&&(t-=parseInt(i.textContent,10)/s);continue}if(c.tagName!=="note")continue;const h=c.querySelector("chord")!==null,S=c.querySelector("rest")!==null,l=c.querySelector("duration"),u=(l!=null&&l.textContent?parseInt(l.textContent,10):s)/s,d=c.querySelector("type"),x=d!=null&&d.textContent?U(d.textContent):V(u),j=c.querySelectorAll("dot").length,N=t,y={id:F(),type:S?"rest":"note",duration:{type:x,dots:j},startBeat:N};if(!S){const i=c.querySelector("pitch");if(i){const b=O(i,m);b&&(y.pitch=b)}}const k=c.querySelectorAll("tie");if(k.length>0){const i=Array.from(k).map(b=>b.getAttribute("type"));i.includes("start")&&i.includes("stop")?y.tie="continue":i.includes("start")?y.tie="start":i.includes("stop")&&(y.tie="stop")}const q=c.querySelector("dynamics");q&&q.firstElementChild&&(y.dynamics=q.firstElementChild.tagName),r.push(y),h||(t+=u)}return r}function O(n,s){var u,d,x;const o=(u=n.querySelector("step"))==null?void 0:u.textContent,r=(d=n.querySelector("octave"))==null?void 0:d.textContent,t=(x=n.querySelector("alter"))==null?void 0:x.textContent;if(!o||!r)return null;const m=t?parseInt(t,10):0,p={C:0,D:2,E:4,F:5,G:7,A:9,B:11}[o];if(p===void 0)return null;const c=(parseInt(r,10)+1)*12+p+m,h=L(c),l=`${o}${m===1?"#":m===-1?"b":""}${r}`,e=X(h,s);return{shinobueNumber:(e==null?void 0:e.number)??0,register:(e==null?void 0:e.register)??"ro",frequency:h,midiNote:c,western:l}}function X(n,s){let o=null,r=1/0;for(const t of s){const m=Math.abs(1200*Math.log2(n/t.frequency));m<r&&(r=m,o=t)}return o}function R(n){var t;const s=(t=n.querySelector("bar-style"))==null?void 0:t.textContent,o=n.querySelector("repeat"),r=o==null?void 0:o.getAttribute("direction");return r==="forward"?"repeat-start":r==="backward"?"repeat-end":s==="light-heavy"?"final":s==="light-light"?"double":"normal"}function U(n){return{whole:"whole",half:"half",quarter:"quarter",eighth:"eighth","16th":"sixteenth","32nd":"thirty-second"}[n]??"quarter"}function V(n){return n>=4?"whole":n>=2?"half":n>=1?"quarter":n>=.5?"eighth":n>=.25?"sixteenth":"thirty-second"}function T(n,s){var r;const o=n.querySelector(s);return((r=o==null?void 0:o.textContent)==null?void 0:r.trim())??null}function M(n,s){var r;const o=n.querySelectorAll("creator");for(const t of o)if(t.getAttribute("type")===s)return((r=t.textContent)==null?void 0:r.trim())??null;return null}const _=[{id:"beginner",label:"入門",desc:"判定が緩く、ガイド表示あり"},{id:"intermediate",label:"中級",desc:"標準的な難易度"},{id:"advanced",label:"上級",desc:"判定が厳しめ"},{id:"master",label:"達人",desc:"ガイドなし、厳密判定"}],D=[{id:"sakura",file:"/songs/sakura.musicxml",title:"さくらさくら",desc:"日本古謡 | 呂音中心の入門曲"},{id:"kojo",file:"/songs/kojo-no-tsuki.musicxml",title:"荒城の月",desc:"滝廉太郎 | 甲音を含む中級曲"},{id:"etenraku",file:"/songs/etenraku.musicxml",title:"越天楽今様",desc:"雅楽 | ゆったりした旋律"},{id:"toryanse",file:"/songs/toryanse.musicxml",title:"通りゃんせ",desc:"わらべうた | リズミカルな曲"},{id:"scale",file:"/songs/scale-exercise.musicxml",title:"音階練習曲",desc:"基礎練習 | 全音域の練習"}];function H({onStart:n}){const{shinobueKey:s}=$(),[o,r]=v.useState("intermediate"),[t,m]=v.useState("sakura"),[f,p]=v.useState({}),[c,h]=v.useState(!1);v.useEffect(()=>{if(f[t])return;const e=D.find(u=>u.id===t);e&&(h(!0),fetch(e.file).then(u=>u.text()).then(u=>{const d=P(u,s);p(x=>({...x,[t]:d}))}).catch(()=>{}).finally(()=>h(!1)))},[t,s,f]);const S=v.useCallback(()=>{const e=f[t];e&&n(e,o)},[o,t,f,n]),l=f[t];return a.jsxs("div",{className:"flex flex-col items-center gap-8 py-8",children:[a.jsx("h2",{className:"text-2xl font-bold theme-text",children:"ゲームモード"}),a.jsxs("div",{className:"theme-bg-card rounded-lg theme-shadow p-6 w-full max-w-md",children:[a.jsx("h3",{className:"text-lg font-semibold mb-3 theme-text",children:"楽曲を選択"}),a.jsx("div",{className:"space-y-2",children:D.map(e=>a.jsxs("button",{onClick:()=>m(e.id),className:`w-full text-left p-3 rounded-lg border-2 transition-colors ${t===e.id?"border-[var(--color-primary)] bg-[var(--color-primary)]/5":"border-[var(--color-border)] hover:border-[var(--color-text-muted)]"}`,children:[a.jsx("div",{className:"font-medium theme-text",children:e.title}),a.jsx("div",{className:"text-xs theme-text-muted",children:e.desc})]},e.id))}),l&&a.jsxs("div",{className:"mt-3 text-xs theme-text-muted",children:[l.measures.length,"小節 | BPM ",l.metadata.tempo]})]}),a.jsxs("div",{className:"theme-bg-card rounded-lg theme-shadow p-6 w-full max-w-md",children:[a.jsx("h3",{className:"text-lg font-semibold mb-2 theme-text",children:"難易度"}),a.jsx("div",{className:"space-y-2",children:_.map(e=>a.jsxs("label",{className:`flex items-center gap-3 p-3 rounded-lg cursor-pointer border-2 transition-colors ${o===e.id?"border-[var(--color-primary)] bg-[var(--color-primary)]/5":"border-[var(--color-border)] hover:border-[var(--color-text-muted)]"}`,children:[a.jsx("input",{type:"radio",name:"difficulty",value:e.id,checked:o===e.id,onChange:()=>r(e.id),className:"accent-[var(--color-primary)]"}),a.jsxs("div",{children:[a.jsx("div",{className:"font-medium theme-text",children:e.label}),a.jsx("div",{className:"text-xs theme-text-muted",children:e.desc})]})]},e.id))})]}),a.jsx("button",{onClick:S,disabled:c||!l,className:"px-10 py-4 theme-btn-primary text-lg font-bold rounded-lg shadow-lg disabled:opacity-50 disabled:cursor-not-allowed","data-testid":"start-game-button",children:c?"読み込み中...":"ゲーム開始"})]})}export{H as GameSelectScreen};
