import{r as i,j as s,G as k,C as S}from"./index-NfBeE4Ix.js";const L=.2,d={bg:"#1A1A1A",judgeLine:"#C41E3A",judgeLineGlow:"rgba(196, 30, 58, 0.3)",gridLine:"rgba(255,255,255,0.06)",ro:"#3B82F6",kan:"#22C55E",daikan:"#EF4444",rest:"rgba(255,255,255,0.1)",perfect:"#FFD700",great:"#FFFFFF",good:"#94A3B8",miss:"#EF4444"},v=28,A=59,T=88,G=T-A;function M({notes:e,currentTimeMs:t,visibleDurationMs:n=4e3,width:r=800,height:a=300}){const o=i.useRef(null),l=i.useCallback(()=>{const c=o.current;if(!c)return;const g=c.getContext("2d");if(!g)return;c.width=r,c.height=a;const u=r*L,m=(r-u)/n;g.fillStyle=d.bg,g.fillRect(0,0,r,a),J(g,t,n,u,m,r,a);const h=t-u/m,b=t+n;for(const f of e)f.timeMs+f.durationMs<h||f.timeMs>b||O(g,f,t,u,m,a);I(g,u,a)},[e,t,n,r,a]);return i.useEffect(()=>{l()},[l]),s.jsx("canvas",{ref:o,width:r,height:a,className:"block rounded-lg",style:{background:d.bg}})}function I(e,t,n){e.save(),e.shadowColor=d.judgeLineGlow,e.shadowBlur=20,e.strokeStyle=d.judgeLine,e.lineWidth=3,e.beginPath(),e.moveTo(t,0),e.lineTo(t,n),e.stroke(),e.restore(),e.strokeStyle=d.judgeLine,e.lineWidth=2,e.beginPath(),e.moveTo(t,0),e.lineTo(t,n),e.stroke()}function J(e,t,n,r,a,o,l){e.strokeStyle=d.gridLine,e.lineWidth=1;const c=500,g=Math.floor((t-r/a)/c)*c;for(let u=g;u<t+n;u+=c){const m=r+(u-t)*a;m<0||m>o||(e.beginPath(),e.moveTo(m,0),e.lineTo(m,l),e.stroke())}}function O(e,t,n,r,a,o){const l=r+(t.timeMs-n)*a,c=Math.max(4,t.durationMs*a-2);if(t.frequency===null){const f=o/2-v/2;e.fillStyle=d.rest,e.fillRect(l,f,c,v);return}const m=(1-((t.midiNote??71)-A)/G)*(o-v);let h=q(t.register),b=1;if(t.judged&&t.judgement)switch(t.judgement.type){case"perfect":h=d.perfect;break;case"great":h=d.great;break;case"good":h=d.good;break;case"miss":h=d.miss,b=Math.max(0,1-(n-t.timeMs)/1e3);break}e.save(),e.globalAlpha=b,e.fillStyle=h,B(e,l,m,c,v,4),e.fill(),c>20&&t.western&&(e.fillStyle=t.judged?"#000":"#FFF",e.font="bold 11px sans-serif",e.textAlign="center",e.textBaseline="middle",e.fillText(t.western,l+c/2,m+v/2)),e.restore()}function q(e){switch(e){case"ro":return d.ro;case"kan":return d.kan;case"daikan":return d.daikan;default:return d.rest}}function B(e,t,n,r,a,o){e.beginPath(),e.moveTo(t+o,n),e.lineTo(t+r-o,n),e.quadraticCurveTo(t+r,n,t+r,n+o),e.lineTo(t+r,n+a-o),e.quadraticCurveTo(t+r,n+a,t+r-o,n+a),e.lineTo(t+o,n+a),e.quadraticCurveTo(t,n+a,t,n+a-o),e.lineTo(t,n+o),e.quadraticCurveTo(t,n,t+o,n),e.closePath()}function D({score:e,combo:t,maxCombo:n}){return s.jsxs("div",{className:"flex items-center gap-8 text-white",children:[s.jsxs("div",{className:"text-center",children:[s.jsx("div",{className:"text-xs text-white/60 uppercase tracking-wider",children:"Score"}),s.jsx("div",{className:"text-3xl font-bold tabular-nums","data-testid":"score-value",children:e.toLocaleString()})]}),s.jsxs("div",{className:"text-center",children:[s.jsx("div",{className:"text-xs text-white/60 uppercase tracking-wider",children:"Combo"}),s.jsx("div",{className:`text-3xl font-bold tabular-nums ${t>=10?"text-yellow-400":""}`,"data-testid":"combo-value",children:t})]}),s.jsxs("div",{className:"text-center",children:[s.jsx("div",{className:"text-xs text-white/60 uppercase tracking-wider",children:"Max"}),s.jsx("div",{className:"text-lg font-medium tabular-nums text-white/80","data-testid":"max-combo-value",children:n})]})]})}const $={perfect:"秀",great:"良",good:"可",miss:"不可"},P={perfect:"text-yellow-400",great:"text-white",good:"text-slate-400",miss:"text-red-500"},W={perfect:"drop-shadow-[0_0_12px_rgba(255,215,0,0.8)]",great:"drop-shadow-[0_0_8px_rgba(255,255,255,0.6)]",good:"",miss:""};function U({judgement:e}){const[t,n]=i.useState(!1),[r,a]=i.useState(null),o=i.useRef(0);if(i.useEffect(()=>{e&&(a(e),n(!0),clearTimeout(o.current),o.current=setTimeout(()=>n(!1),600))},[e]),!t||!r)return null;const l=$[r.type],c=P[r.type],g=W[r.type];return s.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:s.jsx("span",{className:`text-5xl font-bold ${c} ${g} animate-bounce`,role:"status","aria-label":`判定: ${l}`,children:l})})}const z={S:"text-yellow-400",A:"text-green-400",B:"text-blue-400",C:"text-orange-400",D:"text-red-400"},H={S:"drop-shadow-[0_0_20px_rgba(255,215,0,0.8)]",A:"drop-shadow-[0_0_12px_rgba(74,222,128,0.6)]",B:"",C:"",D:""};function K({result:e,onRetry:t,onBack:n}){const r=e.accuracy.toFixed(1);return s.jsxs("div",{className:"flex flex-col items-center gap-8 py-8",children:[s.jsxs("div",{className:"text-center",children:[s.jsx("div",{className:"text-sm text-white/60 uppercase tracking-wider mb-2",children:"Rank"}),s.jsx("div",{className:`text-8xl font-black ${z[e.rank]} ${H[e.rank]}`,"data-testid":"result-rank",children:e.rank})]}),s.jsxs("div",{className:"text-center",children:[s.jsx("div",{className:"text-sm text-white/60 uppercase tracking-wider",children:"Score"}),s.jsx("div",{className:"text-4xl font-bold text-white tabular-nums","data-testid":"result-score",children:e.score.toLocaleString()})]}),s.jsxs("div",{className:"text-center",children:[s.jsx("div",{className:"text-sm text-white/60 uppercase tracking-wider",children:"Accuracy"}),s.jsxs("div",{className:"text-2xl font-semibold text-white tabular-nums","data-testid":"result-accuracy",children:[r,"%"]})]}),s.jsxs("div",{className:"grid grid-cols-4 gap-4 w-full max-w-md","data-testid":"result-breakdown",children:[s.jsx(w,{label:"秀",value:e.perfectCount,color:"text-yellow-400"}),s.jsx(w,{label:"良",value:e.greatCount,color:"text-white"}),s.jsx(w,{label:"可",value:e.goodCount,color:"text-slate-400"}),s.jsx(w,{label:"不可",value:e.missCount,color:"text-red-400"})]}),s.jsxs("div",{className:"text-center text-white/80",children:[s.jsx("span",{className:"text-sm",children:"最大コンボ: "}),s.jsx("span",{className:"text-lg font-bold","data-testid":"result-max-combo",children:e.maxCombo})]}),s.jsxs("div",{className:"flex gap-4 mt-4",children:[s.jsx("button",{onClick:t,className:"px-8 py-3 bg-[#C41E3A] text-white font-bold rounded-lg hover:bg-[#A31830] transition-colors","data-testid":"retry-button",children:"もう一度"}),s.jsx("button",{onClick:n,className:"px-8 py-3 bg-white/20 text-white font-bold rounded-lg hover:bg-white/30 transition-colors","data-testid":"back-button",children:"戻る"})]})]})}function w({label:e,value:t,color:n}){return s.jsxs("div",{className:"text-center",children:[s.jsx("div",{className:`text-2xl font-bold ${n}`,children:t}),s.jsx("div",{className:"text-xs text-white/60",children:e})]})}function Q({score:e,difficulty:t,pitchResult:n,onBack:r}){var C;const[a,o]=i.useState("countdown"),[l,c]=i.useState(null),[g,u]=i.useState(null),[m,h]=i.useState(null),b=i.useRef(null),f=i.useRef(0),N=i.useRef(null);i.useEffect(()=>{N.current=n},[n]),i.useEffect(()=>{const x=new k(e,t,{onJudgement:(p,X,Y)=>{u({...p})},onFinish:p=>{h(p),o("result")},onStateChange:p=>{c({...p})}});return b.current=x,()=>{cancelAnimationFrame(f.current),b.current=null}},[e,t]);const j=i.useCallback(()=>{const x=b.current;!x||x.status!=="playing"||(x.update(N.current),f.current=requestAnimationFrame(j))},[]),y=i.useCallback(()=>{const x=b.current;x&&(x.start(),o("playing"),f.current=requestAnimationFrame(j))},[j]),E=i.useCallback(()=>{const x=b.current;x&&(a==="playing"?(cancelAnimationFrame(f.current),x.pause(),o("paused")):a==="paused"&&(x.resume(),o("playing"),f.current=requestAnimationFrame(j)))},[a,j]),R=i.useCallback(()=>{cancelAnimationFrame(f.current),h(null),u(null),c(null);const x=new k(e,t,{onJudgement:p=>{u({...p})},onFinish:p=>{h(p),o("result")},onStateChange:p=>{c({...p})}});b.current=x,o("countdown")},[e,t]);if(a==="result"&&m)return s.jsx("div",{className:"bg-[#1A1A1A] rounded-lg p-6",children:s.jsx(K,{result:m,onRetry:R,onBack:r})});const _=(l==null?void 0:l.currentTimeMs)??0,F=(l==null?void 0:l.notes)??((C=b.current)==null?void 0:C.gameNotes)??[];return s.jsxs("div",{className:"relative bg-[#1A1A1A] rounded-lg overflow-hidden",children:[s.jsxs("div",{className:"px-6 py-3 flex items-center justify-between border-b border-white/10",children:[s.jsx(D,{score:(l==null?void 0:l.score)??0,combo:(l==null?void 0:l.combo)??0,maxCombo:(l==null?void 0:l.maxCombo)??0}),s.jsxs("div",{className:"flex gap-2",children:[a==="playing"||a==="paused"?s.jsx("button",{onClick:E,className:"px-4 py-2 text-sm bg-white/10 text-white rounded hover:bg-white/20 transition-colors","data-testid":"pause-button",children:a==="paused"?"再開":"一時停止"}):null,s.jsx("button",{onClick:r,className:"px-4 py-2 text-sm bg-white/10 text-white rounded hover:bg-white/20 transition-colors","data-testid":"quit-button",children:"やめる"})]})]}),s.jsxs("div",{className:"relative",children:[s.jsx(M,{notes:F,currentTimeMs:_,width:800,height:300}),s.jsx(U,{judgement:g}),a==="countdown"&&s.jsx(S,{onComplete:y}),a==="paused"&&s.jsx("div",{className:"absolute inset-0 bg-black/60 flex items-center justify-center",children:s.jsx("span",{className:"text-4xl font-bold text-white",children:"一時停止"})})]})]})}export{Q as GameScreen};
